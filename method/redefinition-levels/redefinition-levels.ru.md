# Уровни переопределения

* [Определение](#Определение)
* [Принципы работы с уровнями переопределения](#Принципы-работы-с-уровнями-переопределения)
* [Примеры использования](#Примеры-использования)

## Определение

Уровень переопределения — это директория в БЭМ-проекте, которая содержит файлы реализаций [блоков](../key-concepts/key-concepts.ru.md#Блок), [элементов](../key-concepts/key-concepts.ru.md#Элемент) и [модификаторов](../key-concepts/key-concepts.ru.md#Модификатор). БЭМ-проект состоит минимум из одного уровня переопределения (далее также «уровень»). 

Основные задачи уровней:
* [изменять существующие блоки](#Изменение-существующей-реализации-блока)
* [добавлять новые блоки в проект](#Добавление-блоков-в-проект)

Уровни переопределения позволяют:

* [Работать с одними и теми же БЭМ-сущностями](#Изменение-существующей-реализации-блока)  
  Нет необходимости создавать новую сущность, если нужно изменить уже существующую. Блоку можно добавить новые свойства (**доопределить**) или изменить существующие (**переопределить**) без изменения его исходной реализации и имени.  
* [Сохранять изменения блоков при обновлении библиотеки](#Подключение-библиотеки-блоков-в-проект)  
  Библиотеки подключаются в проект на отдельном уровне. Все необходимые изменения для библиотечных блоков описываются на других уровнях переопределения. Это позволяет сохранить сделанные изменения при обновлении библиотек.   
* [Использовать код повторно](#Разделение-проекта-на-платформы)  
  В БЭМ принято разделять код проекта на общую и специфическую части. Такой подход позволяет отказаться от дублирования кода и сократить время на разработку и поддержку проекта. 
* [Проводить эксперименты в рабочем проекте](#Эксперименты-в-рабочем-проекте)  
  Эксперимент проводится на отдельном уровне переопределения, код рабочего проекта остается неизменным.

## Принципы работы с уровнями переопределения

Работа с уровнями переопределения основана на следующих принципах:

* [БЭМ-проект состоит минимум из одного уровня](#БЭМ-проект-состоит-минимум-из-одного-уровня)
* [Реализация блока может быть разделена по разным уровням](#Реализация-блока-может-быть-разделена-по-разным-уровням)
* [Количество и порядок используемых уровней может меняться](#Количество-и-порядок-используемых-уровней-может-меняться)

### БЭМ-проект состоит минимум из одного уровня

Минимальное количество уровней переопределения в проекте — один. Максимальное – не ограничено. 

Пример файловой структуры БЭМ-проекта с одним уровнем переопределения:

```files
project/
    common.blocks/                # уровень переопределения с блоками проекта
        header/
            header.css    
            header.js
        footer/
            footer.css    
            footer.js
```

Пример файловой структуры БЭМ-проекта с тремя уровнями переопределения (общие блоки проекта и блоки для отдельных страниц):

```files
project/
    common.blocks/                # уровень переопределения с блоками проекта
        header/
            header.css    
            header.js
        footer/
            footer.css    
            footer.js
    index/                        # уровень переопределения с блоками для страницы index
        head/
            head.css              # переопределен вид шапки на заглавной странице
    about/                        # уровень переопределения с блоками для страницы about
        about-text/               # добавлен новый блок
            about-text.css                
```

### Реализация блока может быть разделена по разным уровням

Блоки с любого уровня могут быть изменены на другом уровне переопределения. Изменяемую реализацию блока будем в дальнейшем называть исходной, а измененную — конечной.

Количество уровней, с которых собирается конечная реализация блока, и порядок их подключения может быть любым. Исходная реализация блока дополняется или переопределяется реализациями с каждого последующего уровня. Поэтому в сборку сначала должна попасть исходная реализация, а затем — изменения со всех уровней переопределения.

Схема показывает подключение БЭМ-сущностей с разных уровней переопределения в сборку:

![схема работы уровней переопределения](https://cdn.rawgit.com/innabelaya/bem-docs/174977e4/pics/redefinition-level/redefinition-levels.svg)

> Подробнее о [сборке БЭМ-проектов и порядке подключения БЭМ-сущностей в проект](https://ru.bem.info/methodology/build).

В качестве примера рассмотрим подключение сторонней библиотеки в БЭМ-проект.

#### Подключение библиотеки блоков в проект

Библиотека подключается в БЭМ-проект как отдельный уровень. Блоки из библиотеки могут использоваться в проекте [без изменений](#Пример-подключения-блоков-в-проект) или [дорабатываться под требования проекта](#Изменение-существующей-реализации-блока). 

##### Пример подключения блоков в проект

Предположим, необходимо использовать кнопку из сторонней библиотеки. Для этого достаточно подключить в проект библиотеку с блоком `button` на отдельный уровень. Копировать код блока `button` на уровень с общими проектными блоками не нужно.

Файловая структура проекта с подключенным уровнем библиотеки:

```files
project/
    common.blocks/                      # уровень переопределения с блоками проекта
        header/
        logo/
    library.blocks/                     # уровень переопределения c блоками библиотеки
        button/                         # блок button 
```

В результате [сборки проекта](../build/build.ru.md) блок `button` будет подключен в проект: 

```css
@import "common.blocks/header/header.css";     /* CSS-правила блока header с уровня общих блоков проекта */
@import "library.blocks/logo/logo.css";        /* CSS-правила блока logo с уровня общих блоков проекта */
@import "common.blocks/button/button.css";     /* CSS-правила блока button с уровня библиотеки */
```

##### Изменение существующей реализации блока

Блоки с любого уровня переопределения можно изменять под требования проекта на другом уровне: **доопределять** и **переопределять**. 

Переопределение или доопределение блоков из библиотеки на другом уровне обеспечивает сохранность изменений, сделанных для проекта, при обновлении библиотеки.

Рассмотрим на примере блока `button` из библиотеки, которая подключена в проект как отдельный уровень (`library.blocks`): 

```files
project/
    common.blocks/                      # уровень переопределения с блоками проекта
        header/
        logo/
    library.blocks/                     # уровень переопределения c блоками библиотеки
        button/                         # блок button 
```

Исходная CSS-реализация блока `button`:

CSS-реализация:

```css
/* Блок button в технологии CSS на уровне library.blocks */

.button {
    position: absolute;
    border: 1px solid rgba(0,0,0,.2);
    border-radius: 3px;
    background-color: #fff;
```

Отображение:

![button-default](https://cdn.rawgit.com/innabelaya/bem-docs/27499359/pics/redefinition-level/button-default.svg)

Внесем изменения:

* Переопределим блок — изменим цвет и размер кнопки.
* Доопределим блок — добавим кнопке тень.

Для этого создадим блок `button` на уровне проекта `common.blocks` и разместим в нем файл `button.css` с новыми CSS-правилами для блока `button`.

Файловая структура проекта с блоком `button` на уровне `common.blocks`:

```files
project/
    common.blocks/                      # уровень переопределения с блоками проекта
        header/
        logo/
        button/
            button.css                  # новые правила для блока button
    library.blocks/                     # уровень переопределения c блоками библиотеки
        button/                         # блок button 
            button.css
            button.js
```

Новые CSS-правила:

```css
/* Блок button в технологии CSS на уровне common.blocks */

.button {
    background-color: #ffdf3a;            /* Новый цвет кнопки */
    width: 150px;                         /* Ширина кнопки */
    box-shadow: 0 0 10px rgba(0,0,0,0.5); /* Параметры тени */
}
```

В результате сборки реализация блока `button` будет состоять из исходных CSS-правил с уровня `library.blocks` и добавленных — с уровня `common.blocks`:

```css
@import "library.blocks/button/button.css";   /* Исходные CSS-правила с уровня библиотеки */
@import "common.blocks/button/button.css";    /* Особенности с уровня common.blocks*/
```

Повторяющееся свойство (`background-color`) будет переопределено (фон кнопки изменится на желтый), а новые свойства (`width` и `box-shadow`) — добавлены. Блоку `button` применится следующий набор свойств:

```css
.button {
    position: absolute;
    border: 1px solid rgba(0,0,0,.2);
    border-radius: 3px;
    background-color: #ffdf3a;            /* Новый цвет кнопки */
    width: 150px;                         /* Ширина кнопки */
    box-shadow: 0 0 10px rgba(0,0,0,0.5); /* Параметры тени */
}
```
Новый вид кнопки:

![Переопределенная кнопка](https://cdn.rawgit.com/innabelaya/bem-docs/fd92626a/pics/redefinition-level/button-redefined.svg)

В результате:

* Исходная реализация блока `button` не изменяется.
* Проектные изменения для блока `button` применятся ко всем кнопкам проекта.
* Обновление библиотеки не затронет изменения кнопок для проекта, так как библиотека находится на одном уровне переопределения, а специфические реализации (доработки) блоков — на другом. Если в новой версии библиотеки изменится фон кнопки или ее размеры, в проекте для блока `button` все равно применятся переопределенные правила. 

> **Важно** В БЭМ-проекте любая технология реализации блока может быть пере- или доопределена. Подробнее читайте в разделе [Платформа](https://ru.bem.info/platform/bem-xjst/runtime/).

### Количество и порядок используемых уровней может меняться

В одном проекте можно настраивать разные варианты сборки: определять последовательность и множество уровней для каждого отдельного случая. Простейший пример — для каждой отдельной страницы проекта можно настроить свое используемое множество уровней. 

В БЭМ-проекте файлы, полученные в результате сборки, принято называть [бандлами](../build/build.ru.md/#Введение). Отдельные бандлы можно собирать для всего проекта, отдельной страницы, части страницы и т.д. 

> Подробнее читайте в разделе [Декларации](../declarations/declarations.ru.md/).

В качестве примера рассмотрим сборку проекта, поддерживающего разные платформы. 

#### Разделение проекта на платформы

В проекте, поддерживающем разные платформы (например, `mobile` и `desktop`), часть кода описывает общую функциональность и часть — специфичную для каждой платформы. Чтобы не копировать общий код для реализации каждой из платформ, используются уровни переопределения. 

Общие реализации блоков для всех платформ находятся на одном уровне, например, `common.blocks`, а специфические реализации блоков для мобильных и настольный устройств на двух других: 

* `common.blocks` — общие реализации блоков для всех платформ;
* `desktop.blocks` — специфические реализации блоков для настольных устройств;
* `mobile.blocks` — специфические реализации блоков для мобильных устройств.

Пример файловой структуры проекта:

```files
project/
    common.blocks/
        button/
            button.css    # базовая CSS-реализация кнопки

    desktop.blocks/   
        button/
            button.css    # особенности кнопки для настольных устройств

    mobile.blocks/
        button/
            button.css    # особенности кнопки для мобильных устройств
```

При сборке в файл `desktop.blocks.css` попадут все базовые CSS-правила кнопки с уровня `common.blocks` и переопределенные правила с уровня `desktop.blocks`.

```css
@import "common.blocks/button/button.css";    /* Базовые CSS-правила */
@import "desktop.blocks/button/button.css";   /* Особенности для настольных устройств */
```

Файл `mobile.blocks.css` будет включать базовые CSS-правила кнопки с уровня `common.blocks` и переопределенные правила с уровня `mobile.blocks`.

```css
@import "common.blocks/button/button.css";    /* Базовые CSS-правила */
@import "mobile.blocks/button/button.css";    /* Особенности для мобильных устройств */
```

На рисунке показана сборка проекта для разных платформ в зависимости от юзер-агента:

![Уровни переопределения](https://cdn.rawgit.com/bem-site/bem-method/bem-info-data/method/build/build__levels.svg)

Разделение кода по отдельным уровням переопределеия позволяет иметь одновременно разные сборки одного проекта и предоставлять необходимый вариант в зависимости от юзер-агента. 

## Примеры использования

Наиболее распространенные способы использования уровней переопределения: 
* [Разработка проектов, использующих общие блоки](#Разработка-проектов-использующих-общие-блоки)
* [Создание разных тем оформления проекта](#Создание-разных-тем-оформления-проекта)  
* [Эксперименты в рабочем проекте](#Эксперименты-в-рабочем-проекте)
* [Разделение проекта на платформы](#Разделение-проекта-на-платформы)
* [Подключение библиотеки блоков в проект](Подключение-библиотеки-блоков-в-проект)

### Разработка проектов, использующих общие блоки

Блоки, использующиеся в нескольких проектах, могут быть вынесены на отдельный уровень и подключаться при сборке.

В примере блоки, общие для обоих проектов, вынесены на уровень `common.blocks`:

```files
project/
    common.blocks/      # общие блоки для нескольких проектов
        button/
        input/

    project-1/          # проект 1
        button/         # переопределение блока button для проекта 1
        logo/
        modal/          

    project-2/          # проект 2
        button/         # переопределение блока b1 для проекта 2
        search/
        spin/         
```

### Создание разных тем оформления проекта

Логика работы и внешний вид проекта можно разделить на разные уровни переопределения. Это позволит создавать разные варианты оформления, переключаться между разными темами проекта, комбинировать стили, не изменяя бизнес-логику проекта.

В примере разные темы оформления проекта и общая логика работы разделены на разные уровни. Для изменения внешнего вида проекта достаточно подключить нужный уровень в сборку.

```files
project/
    common.blocks/      # общие блоки для описания бизнес-логики проекта
        button/
        input/
        ...
    alfa/               # тема оформления alfa
        button/
        input/
    beta/               # тема оформления beta
        button/
        input/
```

### Эксперименты в рабочем проекте

Уровни переопределения позволяют проводить [A/B-тестирование](https://ru.wikipedia.org/wiki/A/B-тестирование) непосредственно в рабочем проекте. Во время экспериментов код рабочего проекта не изменяется, так как каждый эксперимент находится на отдельном уровне переопределения.

Пример ниже показывает добавление нескольких экспериментов в рабочий проект: 
* изменение аватарки пользователя (блок `user-pic`);
* изменение отступов в шапке (блок `header`);
* изменение шрифта для имени пользователя (блок `user-name`).

```files
project/                    
    common.blocks/          # блоки проекта
        headr/               
        user-name/          
        user-pic/           
        ...
    exp/
        exp-1/              # уровень для эксперимента №1 
            header/         # новые отступы в шапке          
            user-name/      # новый шрифт для имени пользователя    
            user-pic/       # новый вид аватарки пользователя       
        exp-2/              # уровень для эксперимента №2
            header/         # новые отступы в шапке          
            user-name/      # новый шрифт для имени пользователя    
            user-pic/       # новый вид аватарки пользователя       
        exp-n/              # уровень для любого нового эксперимента
            header/         # новые отступы в шапке          
            user-name/      # новый шрифт для имени пользователя    
            user-pic/       # новый вид аватарки пользователя       
```

Чтобы убрать из проекта неподходящий вариант, достаточно удалить директорию — уровень переопределения неудачного эксперимента.

> Также можно проводить эксперименты, меняя поведение блока или разметку страницы. Например, чтобы обеспечить [доступность сайта (a11y)](https://en.wikipedia.org/wiki/Computer_accessibility), необходимо провести эксперименты по добавлению новых тегов на страницу. Для этого на уровне эксперимента необходимо переопределить шаблоны и JavaScript-код.
